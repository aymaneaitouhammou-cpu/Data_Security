<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureSign | Audit Hybride Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] }, animation: { 'blob': 'blob 7s infinite', 'fade-in': 'fadeIn 0.4s ease-out' }, keyframes: { blob: { '0%': { transform: 'translate(0px, 0px) scale(1)' }, '33%': { transform: 'translate(30px, -50px) scale(1.1)' }, '66%': { transform: 'translate(-20px, 20px) scale(0.9)' }, '100%': { transform: 'translate(0px, 0px) scale(1)' }, }, fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' }, } } } } }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .glass-panel { background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .nav-active { background-color: #3b82f6; color: white; box-shadow: 0 0 20px rgba(59, 130, 246, 0.6); transform: scale(1.05); }
        .nav-inactive { background-color: rgba(30, 41, 59, 0.5); color: #94a3b8; }
        .nav-inactive:hover { background-color: rgba(59, 130, 246, 0.2); color: white; transform: scale(1.02); }
        #reader { border-radius: 12px; overflow: hidden; border: 3px solid #3b82f6; }
        input, textarea, button, select { transition: all 0.2s ease-in-out; }
        .big-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -10px rgba(59, 130, 246, 0.5); }
        .audit-data b { color: #ffffff; font-weight: 700; }
    </style>
</head>
<body class="min-h-screen relative overflow-x-hidden flex flex-col">
    
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10">
        <div class="absolute top-0 left-1/4 w-96 h-96 bg-purple-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute top-0 right-1/4 w-96 h-96 bg-blue-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
    </div>

    <header class="pt-10 pb-6 text-center">
        <div class="inline-flex items-center justify-center space-x-4 mb-3">
            <i class="fa-solid fa-fingerprint text-5xl text-blue-500 drop-shadow-lg"></i>
            <h1 class="text-5xl font-extrabold tracking-tight text-white">Sign<span class="text-blue-500">Ex</span> </h1>
        </div>
        <p class="text-lg text-slate-400">La référence en signature numérique et audit de sécurité.</p>
    </header>

    <div class="flex justify-center mb-10 px-6">
        <div class="glass-panel p-2 rounded-full flex space-x-4 text-lg shadow-lg">
            <button onclick="switchTab('sign')" id="nav-sign" class="nav-active px-8 py-3 rounded-full font-semibold transition-all flex items-center space-x-3">
                <i class="fa-solid fa-pen-nib"></i><span>Signer un Document</span>
            </button>
            <button onclick="switchTab('verify')" id="nav-verify" class="nav-inactive px-8 py-3 rounded-full font-semibold transition-all flex items-center space-x-3">
                <i class="fa-solid fa-shield-halved"></i><span>Espace Vérification</span>
            </button>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-6 pb-20 flex-grow">
        
        <div id="view-sign" class="animate-fade-in grid grid-cols-1 lg:grid-cols-2 gap-10">
            
            <div class="glass-panel rounded-3xl p-8 shadow-2xl border-t-4 border-blue-500 flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-white flex items-center"><i class="fa-solid fa-user-shield mr-3 text-blue-400"></i> Votre Identité</h2>
                    <button onclick="revokeIdentity()" class="text-sm bg-red-500/10 text-red-400 border border-red-500/50 hover:bg-red-500 hover:text-white px-4 py-2 rounded-full transition-colors flex items-center">
                        <i class="fa-solid fa-ban mr-2"></i> Déclarer Vol de Clé
                    </button>
                </div>
                <div class="space-y-6 flex-grow flex flex-col">
                    <div>
                        <label class="text-sm text-slate-300 uppercase font-bold mb-2 block">Nom d'utilisateur</label>
                        <div class="flex gap-3">
                            <input type="text" id="reg_username" placeholder="Ex: Aymane, Professeur..." class="flex-1 bg-slate-800/60 border border-slate-600/50 rounded-xl p-4 text-white text-lg placeholder-slate-500 focus:border-blue-500 outline-none">
                            <button onclick="register()" id="btn_register" class="big-btn bg-blue-600 hover:bg-blue-500 text-white px-6 rounded-xl text-lg font-bold transition-all">Générer Clés</button>
                        </div>
                        <div id="reg_message" class="text-base mt-3 h-6 font-medium"></div>
                    </div>
                    
                    <div id="pubkey_container" class="hidden flex-grow flex flex-col">
                        <label class="text-sm text-green-400 font-bold uppercase block mb-2"><i class="fa-solid fa-key mr-2"></i> Votre Clé Publique (À Partager)</label>
                        <textarea id="display_pubkey" readonly class="w-full flex-grow bg-slate-950 border border-green-500/30 rounded-xl p-4 text-sm font-mono text-green-400 resize-none focus:outline-none" style="min-height: 150px;"></textarea>
                        <button onclick="copyToClipboard('display_pubkey')" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl mt-3 transition-all flex items-center justify-center">
                            <i class="fa-regular fa-copy mr-2"></i> Copier la Clé Publique
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-3xl p-8 shadow-2xl border-t-4 border-purple-500">
                <h2 class="text-2xl font-bold text-white mb-6 flex items-center"><i class="fa-solid fa-file-contract mr-3 text-purple-400"></i> Signer un Document</h2>
                <div class="space-y-6">
                    <label class="text-sm text-slate-300 uppercase font-bold mb-2 block">Sélectionnez le PDF</label>
                    <div class="relative border-3 border-dashed border-slate-600/50 rounded-xl p-8 text-center hover:border-purple-500 transition-colors cursor-pointer group" onclick="document.getElementById('sign_file').click()">
                        <input type="file" id="sign_file" class="hidden" onchange="updateFileName(this, 'sign_file_label')">
                        <i class="fa-solid fa-cloud-arrow-up text-5xl text-slate-500 mb-3 group-hover:text-purple-400 transition-colors"></i>
                        <p id="sign_file_label" class="text-lg text-slate-400 font-medium group-hover:text-white">Cliquez pour choisir un PDF</p>
                    </div>
                    <button onclick="signFile()" id="btn_sign" class="big-btn w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-4 rounded-xl text-xl transition-all shadow-lg shadow-purple-500/30 flex items-center justify-center">
                        <i class="fa-solid fa-signature mr-3"></i> Signer & Tamponner le PDF
                    </button>
                    
                    <div class="flex flex-col md:flex-row items-center gap-6 bg-slate-800/40 p-6 rounded-xl border border-slate-700/50">
                        <div class="bg-white p-3 rounded-xl shadow-md">
                            <img id="qr_image_display" src="https://via.placeholder.com/150?text=QR+Waiting" class="w-32 h-32 object-contain rounded-lg">
                        </div>
                        <div class="flex-1 w-full">
                            <label class="text-sm text-slate-400 font-bold mb-2 block"><i class="fa-solid fa-ticket mr-2"></i> Token JWT (Contenu du QR)</label>
                            <input type="text" id="jwt_token_display" readonly class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-sm font-mono text-slate-400 focus:outline-none placeholder-slate-600" placeholder="Le token apparaîtra ici après signature...">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-verify" class="hidden animate-fade-in max-w-5xl mx-auto">
            <div class="glass-panel rounded-3xl p-8 shadow-2xl border-t-4 border-emerald-500">
                <h2 class="text-3xl font-bold text-white mb-8 text-center flex items-center justify-center"><i class="fa-solid fa-shield-halved mr-4 text-emerald-400"></i> Centre de Vérification & d'Audit</h2>
                
                <div id="reader-container" class="mb-8 hidden">
                    <div class="bg-black/50 p-6 rounded-2xl border-2 border-slate-600 text-center">
                        <p class="text-slate-300 text-lg mb-4 font-bold"><i class="fa-solid fa-camera mr-2"></i> Visez le QR Code</p>
                        <div id="reader" class="w-full max-w-[400px] mx-auto mb-4"></div>
                        <button id="stop-scan-btn" onclick="stopScanner()" class="bg-red-600 hover:bg-red-500 text-white px-8 py-3 rounded-full text-lg font-bold transition-all flex items-center mx-auto">
                            <i class="fa-solid fa-xmark mr-3"></i> Arrêter le Scan
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-gradient-to-br from-slate-800/60 to-slate-900/60 rounded-2xl p-6 border border-slate-600/50 flex flex-col relative overflow-hidden group hover:border-yellow-400/50 transition-colors">
                        <div class="absolute -right-10 -top-10 bg-yellow-400/10 w-32 h-32 rounded-full blur-2xl group-hover:bg-yellow-400/20 transition-all"></div>
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center"><i class="fa-solid fa-mobile-screen-button mr-3 text-yellow-400 text-2xl"></i> Scan Rapide (Mobile)</h3>
                        <p class="text-sm text-slate-400 mb-6 flex-grow">Utilisez la caméra pour scanner un QR code. La clé publique sera récupérée automatiquement par le serveur.</p>
                        
                        <button id="start-scan-btn" onclick="startScanner()" class="big-btn w-full bg-yellow-500 hover:bg-yellow-400 text-slate-900 font-bold py-4 rounded-xl text-lg shadow-lg shadow-yellow-500/20 flex items-center justify-center transition-all">
                            <i class="fa-solid fa-camera mr-3 text-xl"></i> Activer la Caméra
                        </button>
                        <p class="text-center text-xs text-yellow-400/70 mt-3 font-medium">⚠️ Vérifie l'identité, mais pas le contenu.</p>
                    </div>
    
                    <div class="bg-gradient-to-br from-slate-800/60 to-slate-900/60 rounded-2xl p-6 border border-slate-600/50 flex flex-col relative overflow-hidden group hover:border-emerald-400/50 transition-colors">
                        <div class="absolute -right-10 -top-10 bg-emerald-400/10 w-32 h-32 rounded-full blur-2xl group-hover:bg-emerald-400/20 transition-all"></div>
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center"><i class="fa-solid fa-desktop mr-3 text-emerald-400 text-2xl"></i> Audit Complet (PC)</h3>
                        <p class="text-sm text-slate-400 mb-6 flex-grow">Nécessite le fichier original pour une vérification d'intégrité cryptographique complète.</p>
                        
                        <div class="relative border-3 border-dashed border-slate-600/50 rounded-xl p-4 text-center hover:border-emerald-500 transition-colors cursor-pointer group" onclick="document.getElementById('verify_file').click()">
                            <input type="file" id="verify_file" class="hidden" onchange="updateFileName(this, 'verify_file_label')">
                            <i class="fa-solid fa-file-shield text-3xl text-slate-500 mb-2 group-hover:text-emerald-400 transition-colors"></i>
                            <p id="verify_file_label" class="text-base text-slate-400 font-medium group-hover:text-white">Choisir le Fichier Original</p>
                        </div>
                         <p class="text-center text-xs text-emerald-400/70 mt-3 font-medium">✅ Vérifie l'identité ET le contenu.</p>
                    </div>
                </div>

                <div class="space-y-4 mb-6">
                    <label class="text-sm text-slate-300 uppercase font-bold block mb-2">Données Cryptographiques</label>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <input type="text" id="verify_jwt" placeholder="1. Token JWT (Scanner ou Coller ici)" class="w-full bg-slate-800/60 border border-slate-600 rounded-xl p-4 text-base font-mono text-emerald-400 focus:border-emerald-500 outline-none placeholder-slate-500">
                        <input type="text" id="verify_pubkey" placeholder="2. Clé Publique (Optionnelle sur mobile)" class="w-full bg-slate-800/60 border border-slate-600 rounded-xl p-4 text-base font-mono text-white focus:border-blue-500 outline-none placeholder-slate-500">
                    </div>
                </div>

                <button onclick="verifyFile()" id="btn_verify" class="big-btn w-full bg-gradient-to-r from-blue-600 to-emerald-600 hover:from-blue-500 hover:to-emerald-500 text-white font-bold py-5 rounded-xl text-2xl transition-all shadow-lg flex items-center justify-center">
                    <i class="fa-solid fa-magnifying-glass-chart mr-4"></i> Lancer l'Analyse de Sécurité
                </button>
                
                <div id="verify_result" class="hidden mt-8 p-0 rounded-2xl overflow-hidden animate-fade-in shadow-xl"></div>
            </div>
        </div>
    </main>

    <script>
        // --- NAVIGATION ---
        function switchTab(t) {
            document.getElementById('view-sign').classList.toggle('hidden', t !== 'sign');
            document.getElementById('view-verify').classList.toggle('hidden', t !== 'verify');
            document.getElementById('nav-sign').className = t === 'sign' ? "nav-active px-8 py-3 rounded-full font-semibold flex items-center space-x-3" : "nav-inactive px-8 py-3 rounded-full font-semibold flex items-center space-x-3 cursor-pointer";
            document.getElementById('nav-verify').className = t === 'verify' ? "nav-active px-8 py-3 rounded-full font-semibold flex items-center space-x-3" : "nav-inactive px-8 py-3 rounded-full font-semibold flex items-center space-x-3 cursor-pointer";
        }

        // --- UTILS ---
        function setLoading(id, l) { const b=document.getElementById(id); if(l){b.dataset.t=b.innerHTML;b.innerHTML='<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Traitement...';b.disabled=true;b.classList.add('opacity-75');}else{b.innerHTML=b.dataset.t;b.disabled=false;b.classList.remove('opacity-75');} }
        function updateFileName(i, id) { if(i.files[0]) { document.getElementById(id).innerText = "Fichier : " + i.files[0].name; document.getElementById(id).classList.add('text-white'); } }
        function copyToClipboard(id) { 
            const el = document.getElementById(id); el.select(); document.execCommand("copy"); 
            const btn = el.nextElementSibling; const oldHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> Copié !'; btn.classList.add('bg-green-600');
            setTimeout(() => { btn.innerHTML = oldHtml; btn.classList.remove('bg-green-600'); }, 2000);
        }

        // --- SCANNER ---
        let scanner;
        function startScanner() {
            document.getElementById('reader-container').classList.remove('hidden');
            document.getElementById('start-scan-btn').classList.add('hidden');
            scanner = new Html5Qrcode("reader");
            scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 300, height: 300 } }, (txt) => {
                document.getElementById('verify_jwt').value = txt;
                stopScanner();
                alert("✅ Token QR Code détecté avec succès !");
                const input = document.getElementById('verify_jwt');
                input.style.borderColor = "#10b981";
                setTimeout(() => input.style.borderColor = "", 1000);
            });
        }
        function stopScanner() { 
            if(scanner) scanner.stop().then(() => { 
                document.getElementById('reader-container').classList.add('hidden');
                document.getElementById('start-scan-btn').classList.remove('hidden');
            }); 
        }

        // --- API CALLS ---
        async function register() {
            const u = document.getElementById('reg_username').value;
            if(!u) return alert("Veuillez entrer un nom d'utilisateur.");
            setLoading('btn_register', true);
            try {
                const res = await fetch('/api/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u}) });
                const d = await res.json();
                document.getElementById('pubkey_container').classList.remove('hidden');
                document.getElementById('display_pubkey').value = d.public_key;
                document.getElementById('reg_message').innerHTML = '<span class="text-green-400 font-bold flex items-center"><i class="fa-solid fa-circle-check mr-2"></i> Identité Active !</span>';
                document.getElementById('verify_pubkey').value = d.public_key;
            } catch(e) { alert("Erreur serveur."); } finally { setLoading('btn_register', false); }
        }

        async function signFile() {
            const u = document.getElementById('reg_username').value;
            const f = document.getElementById('sign_file').files[0];
            if(!u) return alert("Générez d'abord une identité.");
            if(!f) return alert("Choisissez un fichier.");
            setLoading('btn_sign', true);
            const fd = new FormData(); fd.append('username', u); fd.append('file', f);
            try {
                const res = await fetch('/api/sign', { method:'POST', body:fd });
                const d = await res.json();
                if(d.error) return alert("Erreur : " + d.error);
                document.getElementById('qr_image_display').src = "data:image/png;base64,"+d.qr_image;
                document.getElementById('jwt_token_display').value = d.jwt_token;
                document.getElementById('verify_jwt').value = d.jwt_token;
                if(d.signed_pdf) {
                    const l = document.createElement('a'); l.href='data:application/pdf;base64,'+d.signed_pdf; l.download="SIGNE_PAR_SIGNEX_"+d.filename; l.click();
                    alert("✅ Document signé et téléchargé !");
                }
            } catch(e) { alert("Erreur signature."); } finally { setLoading('btn_sign', false); }
        }

        async function verifyFile() {
            const t = document.getElementById('verify_jwt').value;
            const k = document.getElementById('verify_pubkey').value;
            const f = document.getElementById('verify_file').files[0];
            
            if(!t) return alert("Erreur : Le Token JWT est obligatoire (Scanner le QR).");
            
            setLoading('btn_verify', true);
            const div = document.getElementById('verify_result'); div.classList.add('hidden');
            const fd = new FormData(); 
            fd.append('jwt_token', t); 
            // On envoie la clé seulement si elle existe (PC), sinon le serveur se débrouille
            if(k) fd.append('public_key', k);
            if(f) fd.append('file', f);

            try {
                const res = await fetch('/api/verify', { method:'POST', body:fd });
                const d = await res.json();
                div.classList.remove('hidden');
                let colors="", title="", icon="";
                if (d.mode === "full") { colors="border-emerald-500 bg-emerald-500/10 text-emerald-300"; title="AUDIT COMPLET (SUCCÈS)"; icon="fa-shield-check"; }
                else if (d.mode === "partial") { colors="border-yellow-500 bg-yellow-500/10 text-yellow-300"; title="IDENTITÉ CONFIRMÉE (SCAN MOBILE)"; icon="fa-user-check"; }
                else if (d.mode === "revoked") { colors="border-red-600 bg-red-600/20 text-red-400"; title="CLÉ VOLÉE (RÉVOQUÉE)"; icon="fa-ban"; }
                else { colors="border-red-500 bg-red-500/10 text-red-300"; title="ÉCHEC DE L'AUDIT"; icon="fa-triangle-exclamation"; }
                
                div.className = `mt-8 rounded-2xl border-2 ${colors} overflow-hidden animate-fade-in shadow-2xl`;
                div.innerHTML = `
                    <div class="p-4 text-center border-b border-white/10 bg-white/5 flex items-center justify-center">
                        <i class="fa-solid ${icon} text-4xl mr-3"></i>
                        <h3 class="font-bold text-2xl">${title}</h3>
                    </div>
                    <div class="p-6 text-lg text-center leading-relaxed audit-data">${d.message}</div>
                `;
            } catch(e) { alert("Erreur lors de la vérification."); } finally { setLoading('btn_verify', false); }
        }

        async function revokeIdentity() {
            const u = document.getElementById('reg_username').value;
            if(!u) return alert("Nom requis.");
            if(!confirm("⚠️ ATTENTION : Déclarer cette clé comme VOLÉE ?")) return;
            try {
                 const res = await fetch('/api/revoke', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u}) });
                 const d = await res.json();
                 alert("✅ " + d.message);
            } catch(e) { alert("Erreur serveur."); }
        }
    </script>
</body>
</html>